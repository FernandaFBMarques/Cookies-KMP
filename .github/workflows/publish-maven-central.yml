name: Publish to Maven Central

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version in shared/build.gradle.kts (e.g. 0.1.0 or 0.1.0-SNAPSHOT)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Validate version input
        run: |
          set -euo pipefail
          INPUT_VERSION="${{ github.event.inputs.version }}"
          BUILD_VERSION="$(sed -n 's/^version = "\(.*\)"/\1/p' shared/build.gradle.kts | head -n1)"
          echo "Input version: ${INPUT_VERSION}"
          echo "Build file version: ${BUILD_VERSION}"
          if [ -z "${BUILD_VERSION}" ]; then
            echo "Could not read version from shared/build.gradle.kts"
            exit 1
          fi
          if [ "${INPUT_VERSION}" != "${BUILD_VERSION}" ]; then
            echo "Version mismatch. Update shared/build.gradle.kts or run with matching input."
            exit 1
          fi

      - name: Validate required secrets exist
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          set -euo pipefail
          missing=0
          for name in MAVEN_CENTRAL_USERNAME MAVEN_CENTRAL_PASSWORD SIGNING_KEY_ID SIGNING_KEY; do
            if [ -z "${!name:-}" ]; then
              echo "Missing secret: ${name}"
              missing=1
            fi
          done
          if [ -z "${SIGNING_KEY_PASSWORD:-}" ] && [ -z "${SIGNING_PASSWORD:-}" ]; then
            echo "Missing secret: SIGNING_KEY_PASSWORD (or SIGNING_PASSWORD)"
            missing=1
          fi
          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi
          echo "All required secrets are present."

      - name: Normalize signing key material
        env:
          RAW_SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          set -euo pipefail
          KEY="${RAW_SIGNING_KEY}"

          # If the key was pasted with escaped newlines, convert them.
          if echo "${KEY}" | grep -q "\\\\n"; then
            KEY="$(printf '%b' "${KEY}")"
          fi

          # If not already armored, try base64 decode.
          if ! echo "${KEY}" | grep -q "BEGIN PGP PRIVATE KEY BLOCK"; then
            if DECODED="$(echo "${KEY}" | base64 -d 2>/dev/null)"; then
              KEY="${DECODED}"
            fi
          fi

          if ! echo "${KEY}" | grep -q "BEGIN PGP PRIVATE KEY BLOCK"; then
            echo "SIGNING_KEY is not a valid ASCII-armored private key (or decodable base64 of it)."
            exit 1
          fi

          {
            echo "ORG_GRADLE_PROJECT_signingInMemoryKey<<EOF"
            echo "${KEY}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Choose publish task
        id: choose-task
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.version }}"
          if [[ "${VERSION}" == *"-SNAPSHOT" ]]; then
            echo "task=:cookies-kmp-core:publishToMavenCentral" >> "$GITHUB_OUTPUT"
          else
            echo "task=:cookies-kmp-core:publishAndReleaseToMavenCentral" >> "$GITHUB_OUTPUT"
          fi
          echo "Selected task: $(cat "$GITHUB_OUTPUT")"

      - name: Publish and release
        run: ./gradlew "${{ steps.choose-task.outputs.task }}" --no-daemon --stacktrace --info
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_KEY_PASSWORD || secrets.SIGNING_PASSWORD }}
